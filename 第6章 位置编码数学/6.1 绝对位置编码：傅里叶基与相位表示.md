# 第6章 位置编码数学
## 6.1 正弦余弦位置编码的数学基础

在深度学习序列建模的发展历程中，如何让模型感知序列中元素的位置信息一直是一个核心问题。Transformer架构的出现从根本上改变了这一局面，注意力机制允许序列中任意两个位置之间直接建立联系，实现了真正的并行计算。但这种并行化的代价是位置信息的丢失，纯注意力机制是置换不变的，即改变输入序列的顺序不会改变注意力输出的顺序。位置编码的引入正是为了解决这一根本性问题：通过向输入嵌入添加位置相关的信息，使注意力机制能够感知序列中各元素的绝对或相对位置，从而正确处理词序承载的语法和语义信息。

正弦余弦位置编码是Transformer原始论文中提出的位置编码方案，这种编码利用不同频率的正弦和余弦函数来唯一标识序列中的每个位置，具有优雅的数学形式和良好的理论性质。本节将从数学角度系统分析正弦余弦位置编码的定义、频率空间的映射关系、相位偏移的几何意义，以及这组固定基函数的数学本质。

### 6.1.1 正弦余弦位置编码的统一表达

正弦余弦位置编码的核心思想是为序列中的每个位置生成一个$d$维的编码向量，该向量的各维度由不同频率的正弦和余弦函数值组成。设序列长度为$n$，嵌入维度为$d_{\text{model}}$，位置$i$的编码向量$p_i \in \mathbb{R}^{d_{\text{model}}}$定义为：

$$
\begin{align*}
p_{i, 2m} = \sin\left(\frac{i}{10000^{2m/d_{\text{model}}}}\right), \\\quad p_{i, 2m+1} = \cos\left(\frac{i}{10000^{2m/d_{\text{model}}}}\right) \tag{6.1.1}
\end{align*}
$$

其中，$i \in \{0, 1, 2, \ldots, n-1\}$表示序列中的位置索引，$m \in \{0, 1, 2, \ldots, d_{\text{model}}/2 - 1\}$表示维度索引，$10000$是一个经验性选择的常数基准。编码向量的偶数维度由正弦函数给出，奇数维度由余弦函数给出，两者成对出现，这种配对设计使得每个频率成分同时包含正弦和余弦分量。

将上述公式写成更紧凑的形式，定义角频率参数$\omega_m$为：

$$
\omega_m = 10000^{2m/d_{\text{model}}} \tag{6.1.2}
$$

则位置编码可以表示为：
$$
\begin{align*}
\mathbf{p}_i
=
\bigl(
\sin \tfrac{i}{\omega_0},
\cos \tfrac{i}{\omega_0},
\;\ldots\;,
\sin \tfrac{i}{\omega_{d/2-1}},
\cos \tfrac{i}{\omega_{d/2-1}}
\bigr)^\top
\tag{6.1.3}
\end{align*}

$$
角频率$\omega_m$随维度$m$呈指数级变化。对于低维度（小的$m$），$\omega_m$较小，对应高频振动；对于高维度（大的$m$），$\omega_m$较大，对应低频振动。这种设计使得低维度能够编码位置的精细变化（精确位置、近距离关系），高维度能够编码位置的整体结构（整体位置、远距离关系）。从频率的角度看，定义频率$f_m = 1/\omega_m = 10000^{-2m/d_{\text{model}}}$，则编码公式可写为：

$$
p_{i, 2m} = \sin(2\pi f_m \cdot i), \quad p_{i, 2m+1} = \cos(2\pi f_m \cdot i) \tag{6.1.4}
$$

这里引入$2\pi$因子是为了与标准的傅里叶分析保持一致，其中$f_m$是归一化频率。频率在对数尺度上均匀分布，$\log_{10000}(f_m) = -2m/d_{\text{model}}$，这意味着相邻频率之间的比率是恒定的。

使用复数形式可以更优雅地统一表达正弦余弦编码。定义位置$i$的复数编码向量$c_i \in \mathbb{C}^{d_{\text{model}}/2}$为：

$$
c_i[m] = e^{-i \cdot 2\pi f_m \cdot i} = \exp\left(-i \cdot 2\pi \cdot i \cdot 10000^{-2m/d_{\text{model}}}\right) \tag{6.1.5}
$$

其中，$i = \sqrt{-1}$是虚数单位。这个复数编码与实数编码的关系为：

$$
c_i[m] = \cos(2\pi f_m \cdot i) - i \sin(2\pi f_m \cdot i) \tag{6.1.6}
$$

实数编码向量可以通过取复数编码的实部和虚部交替排列得到。复数形式的优雅之处在于它将正弦和余弦统一为一个复指数运算，消除了分别处理正弦和余弦的复杂性。复数编码的内积具有简洁的形式：

$$
\langle c_i, c_j \rangle = \sum_{m=0}^{d_{\text{model}}/2-1} c_i[m] \cdot \overline{c_j[m]} = \sum_{m=0}^{d_{\text{model}}/2-1} e^{-i \cdot 2\pi f_m \cdot (i-j)} \tag{6.1.7}
$$

实数编码的点积与复数编码的内积直接相关：

$$
\begin{align*}
& p_i \cdot p_j = \text{Re}\left( \sum_{m=0}^{d_{\text{model}}/2-1} c_i[m] \cdot \overline{c_j[m]} \right) \\& = \sum_{m=0}^{d_{\text{model}}/2-1} \cos(2\pi f_m \cdot (i-j)) \tag{6.1.8}
\end{align*}
$$

这个结果具有深刻的数学意义：位置编码的点积只依赖于位置差$\Delta = i - j$，与绝对位置$i$和$j$无关。这意味着位置编码隐式地编码了相对位置信息。

### 6.1.2 频率空间与位置映射

正弦余弦位置编码的精妙之处在于其背后的频率空间数学结构。从傅里叶分析的角度来看，位置编码实际上是不同频率正弦波的叠加，低频成分捕获位置的整体结构和长距离关系，高频成分捕获位置的精细变化和短距离差异。这种多尺度的频率表示与人类感知和处理信息的方式有着有趣的相似性。

傅里叶级数是分析周期函数的经典工具，它将任意周期函数表示为不同频率正弦和余弦函数的叠加。设$f(t)$是周期为$T$的周期函数，傅里叶级数展开定义为：

$$
f(t) = \frac{a_0}{2} + \sum_{n=1}^{\infty} \left[ a_n \cos\left(\frac{2\pi n t}{T}\right) + b_n \sin\left(\frac{2\pi n t}{T}\right) \right] \tag{6.1.9}
$$

傅里叶级数的深刻意义在于它证明了任意周期函数都可以分解为不同频率正弦和余弦函数的线性组合。频率$n$称为第$n$次谐波，基频为$\omega_0 = 2\pi/T$，第$n$次谐波的角频率为$n\omega_0$。不同的频率成分携带函数的不同信息：低频成分描述函数的整体趋势，高频成分描述函数的细节变化。

在复数形式下，傅里叶级数可以更加简洁地表示。引入复指数函数$e^{i\omega t} = \cos(\omega t) + i\sin(\omega t)$，周期函数可以展开为：

$$
f(t) = \sum_{n=-\infty}^{\infty} c_n e^{i \frac{2\pi n t}{T}} \tag{6.1.10}
$$

复数形式的优点在于它统一处理正弦和余弦分量，数学表达式更加紧凑，且便于进行复变函数分析。对于位置编码的分析，我们可以将位置$i$的编码向量视为一个离散序列，维度$m$对应不同的频率成分。

位置编码可以自然地视为不同频率正弦波的叠加。考虑位置$i$的编码向量$p_i$，将其按维度配对$(p_{i,2m}, p_{i,2m+1})$组织，每个配对对应一个特定的频率成分。对于维度配对$m$，复数形式的编码分量为：

$$
\begin{align*}
& c_{i,m} = p_{i,2m} + i \cdot p_{i,2m+1} \\& = \sin(2\pi f_m \cdot i) + i \cos(2\pi f_m \cdot i) \\& = e^{i \cdot 2\pi f_m \cdot i} \tag{6.1.11}
\end{align*}
$$

整个编码向量是不同频率复指数序列的实部和虚部的组合。整个编码向量的频谱可以表示为冲激函数的叠加：

$$
X[k] = \sum_{m=0}^{d_{\text{model}}/2-1} \delta(k - k_m) \tag{6.1.12}
$$

其中，$k_m$是与频率$f_m$对应的频率索引，$\delta(\cdot)$是克罗内克$\delta$函数。这个频谱表示表明位置编码的能量完全集中在有限的几个离散频率上，没有连续的分量。

正弦余弦位置编码采用指数分布的频率：$f_m = 10000^{-2m/d_{\text{model}}}$。这种多尺度的频率结构具有深刻的数学意义。从对数频率的角度来看，各频率成分在对数尺度上是均匀分布的：

$$
\log_{10000}(f_m) = -\frac{2m}{d_{\text{model}}} \tag{6.1.13}
$$

这意味着频率在对数域上是等间隔分布的。这种设计使得编码能够在多个数量级上同时捕获位置信息：低频成分覆盖长距离的位置关系，高频成分覆盖短距离的位置关系。从分辨率的角度，不同频率成分提供不同精度的位置表示，低频成分的周期较长，能够覆盖整个长序列；高频成分的周期较短，能够精确区分相近的位置。这种多分辨率分析与小波变换的思想一致，使用不同尺度的基函数同时捕获全局和局部特征。

从信息论的角度，位置编码需要为$n$个位置编码约$\log_2 n$比特的信息。多尺度频率结构可以看作是一种高效的编码方案：它不是为每个位置独立编码，而是使用不同频率的正弦波叠加来表示位置。这种编码方式在数学上具有完备性，给定足够多的频率成分，可以唯一确定任意位置。

### 6.1.3 相位偏移的几何意义

从相位角度理解位置编码可以获得更深刻的洞察。考虑编码向量$p_i$的每个维度配对$(p_{i,2m}, p_{i,2m+1}) = (\sin(2\pi f_m \cdot i), \cos(2\pi f_m \cdot i))$，其中$\theta_{i,m} = 2\pi f_m \cdot i$是第$m$个频率成分在位置$i$处的相位。相位$\theta_{i,m}$随位置$i$线性增加，增长率为频率$f_m$。因此，位置编码可以理解为在每个频率维度上，相位随位置均匀进动，就像一个旋转的指针，转速由频率决定。

两个位置的相位差为$\Delta\theta_m = \theta_{j,m} - \theta_{i,m} = (j - i) \cdot 2\pi f_m = \Delta \cdot 2\pi f_m$，其中$\Delta = j - i$是相对位置。这个相位差正好对应点积公式中的$\cos(\Delta \cdot 2\pi f_m)$项。点积可以解释为各频率成分相位差余弦的叠加，揭示了相对位置信息如何在频率空间中编码。

使用复数编码，相位偏移的几何意义更加直观。考虑位置$i$的复数编码$c_i[m] = e^{-i \cdot 2\pi f_m \cdot i}$，它可以视为复平面上单位圆上的一个点，其辐角为$\theta_{i,m} = -2\pi f_m \cdot i$。当位置从$i$变为$i+1$时，辐角增加$\Delta\theta_m = -2\pi f_m$，即点沿圆周旋转角度$-2\pi f_m$。

两个位置的编码之间的关系可以通过相对旋转来描述。设$c_i$和$c_j$是位置$i$和$j$的编码，则：

$$
c_j[m] = c_i[m] \cdot e^{-i \cdot 2\pi f_m \cdot (j-i)} = c_i[m] \cdot \exp\left(-i \cdot \Delta \cdot 2\pi f_m\right) \tag{6.1.14}
$$

这意味着$c_j$可以通过将$c_i$在复平面上旋转角度$\Delta \cdot 2\pi f_m$得到。因此，相对位置对应于复平面上的相对旋转，旋转角度由相对位置和频率共同决定。从几何角度，每个频率成分定义了一个独立的复平面，位置编码是这些平面上点的集合。相对位置编码问题转化为给定两个点在各自平面上的位置，计算它们之间的相对旋转角度。

从群论的角度，相位编码对应于圆群上的平移操作。每个频率成分定义了一个独立的圆群，位置$i$对应圆群上的点$e^{i\theta_{i,m}}$。相对位置对应于圆群上的平移，其效果是两个点的距离由点积给出，且与绝对位置无关。这种群论视角揭示了位置编码的深层代数结构。

考虑位置变换算子$T$，它将位置$i$的编码映射到位置$i+1$的编码。使用复数编码，这个算子可以表示为：

$$
\begin{align*}
&T(c_i)[m] = c_{i+1}[m] \\& = e^{-i \cdot 2\pi f_m \cdot (i+1)} = e^{-i \cdot 2\pi f_m \cdot i} \cdot e^{-i \cdot 2\pi f_m} = c_i[m] \cdot r_m \tag{6.1.15}
\end{align*}
$$

其中，$r_m = e^{-i \cdot 2\pi f_m}$是第$m$个频率成分对应的旋转因子。因此，位置变换算子$T$在频率空间中是一个对角矩阵，对角元素为各频率成分的旋转因子$r_m$。位置$i$的编码可以表示为初始编码$c_0$经过$T^i$次变换的结果：

$$
c_i = T^i(c_0) = \text{diag}(r_0^i, r_1^i, \ldots, r_{d_{\text{model}}/2-1}^i) c_0 \tag{6.1.16}
$$

其中，$r_m^i = e^{-i \cdot 2\pi f_m \cdot i}$。这个表达式清楚地揭示了位置编码的生成机制：位置$i$的编码是初始编码经过各频率成分独立旋转$i$次后的结果。

考虑两个位置$i$和$i+\delta$（$\delta$是小的距离差）的编码向量差。使用三角恒等式，编码差可以表示为：

$$
p_{i+\delta} - p_i = \begin{bmatrix} 2 \cos\left(\frac{2\pi f_m(2i+\delta)}{2}\right) \sin\left(\frac{\pi f_m \delta}{1}\right) \\ -2 \sin\left(\frac{2\pi f_m(2i+\delta)}{2}\right) \sin\left(\frac{\pi f_m \delta}{1}\right) \end{bmatrix} \tag{6.1.17}
$$
差向量的模为：

$$
\|p_{i+\delta} - p_i\| = 2 \left| \sin\left(\pi f_m \delta\right) \right| \approx \left| 2\pi f_m \delta \right| \quad \text{当 } \delta \ll 1/f_m \text{ 时} \tag{6.1.18}
$$

这个结果清楚地表明位置差$\delta$的编码分辨率与频率$f_m$成正比。对于高频成分（大的$f_m$），相同的位置差产生的编码差异较大；对于低频成分（小的$f_m$），相同的位置差产生的编码差异较小。这种特性使得位置编码能够同时适应不同粒度的位置表示需求。

### 6.1.4 固定基函数的数学本质

正弦余弦位置编码之所以能够有效表示位置信息，根本原因在于它使用了一组精心设计的固定基函数。这组基函数具有独特的数学性质，使其能够唯一表示任意位置，同时具有良好的泛化能力和长度外推特性。

从线性代数的角度，位置编码向量集合$\{p_0, p_1, \ldots, p_{n-1}\}$可以视为一组基向量的线性组合。定义基函数集$\{\phi_m^{\sin}(i), \phi_m^{\cos}(i)\}$，其中：

$$
\phi_m^{\sin}(i) = \sin(2\pi f_m \cdot i), \quad \phi_m^{\cos}(i) = \cos(2\pi f_m \cdot i) \tag{6.1.19}
$$

位置$i$的编码向量$p_i$正是这组基函数在位置$i$处的取值构成的向量。基函数的数量为$d_{\text{model}}$，正好等于编码向量的维度。这组基函数的核心性质是它们在整数位置上的线性无关性。

考虑编码向量序列的线性组合。假设存在非零系数$\alpha_i$使得：

$$
\sum_{i=0}^{n-1} \alpha_i p_i = 0 \tag{6.1.20}
$$

将$p_i$按基函数展开，对于每个频率$f_m$有：

$$
\sum_{i=0}^{n-1} \alpha_i \sin(2\pi f_m \cdot i) = 0, \quad \sum_{i=0}^{n-1} \alpha_i \cos(2\pi f_m \cdot i) = 0 \tag{6.1.21}
$$

这些方程表明权重序列$\alpha_i$与正弦序列和余弦序列正交。由于频率$f_m$是互不相同的无理数倍数（当$d_{\text{model}}$足够大时），所有这些正交条件意味着$\alpha_i = 0$对于所有$i$成立。因此，编码向量序列是线性无关的，不同位置具有不同的编码。这种线性无关性保证了基函数集合的完备性。

基函数集$\{\phi_m^{\sin}, \phi_m^{\cos}\}$在整数位置上的正交性是一个重要性质。对于两个不同的频率$f_m$和$f_{m'}$：

$$
\sum_{i=0}^{n-1} \sin(2\pi f_m \cdot i) \sin(2\pi f_{m'} \cdot i) = \begin{cases} n/2 & m = m' \\ 0 & m \neq m' \end{cases} \tag{6.1.22}
$$

$$
\sum_{i=0}^{n-1} \cos(2\pi f_m \cdot i) \cos(2\pi f_{m'} \cdot i) = \begin{cases} n/2 & m = m' \\ 0 & m \neq m' \end{cases} \tag{6.1.23}
$$

$$
\sum_{i=0}^{n-1} \sin(2\pi f_m \cdot i) \cos(2\pi f_{m'} \cdot i) = 0 \quad \forall m, m' \tag{6.1.24}
$$

这种正交性意味着不同频率的基函数在整数位置上是互不干扰的，每个频率成分独立地贡献位置信息。正交基函数的优点在于它们可以独立调整而不影响其他成分，这简化了学习和优化过程。

这组固定基函数的另一个重要性质是平移不变性。对于任意位置$i$和任意平移量$\delta$：

$$
p_{i+\delta} \cdot p_j = p_i \cdot p_{j-\delta} \tag{6.1.25}
$$

这个性质来源于点积公式$p_i \cdot p_j = \sum_m \cos(2\pi f_m \cdot (i-j))$，它只依赖于相对位置差。相对位置编码的平移不变性使得模型能够学习与绝对位置无关的相对依赖模式，这正是许多自然语言处理任务所需要的。

固定基函数相比可学习位置编码具有几个关键优势。首先是长度外推能力，由于基函数是由数学公式定义的，它们可以自然地计算任意整数位置的编码，不受训练时序列长度的限制。可学习位置编码只能处理训练时见过的长度，对于超出范围的序列需要特殊处理。其次是参数效率，固定基函数不需要任何可训练参数，参数效率为100%。可学习位置编码需要$O(n_{\max} \cdot d)$的参数量，当$n_{\max}$很大时这是一笔不小的开销。第三是稳定性，固定基函数的输出是确定性的，不受训练随机性的影响。可学习位置编码可能在不同训练运行中产生不同的结果，引入额外的方差。

从贝叶斯推断的角度，固定基函数可以视为对位置先验的一种建模。指数频率分布对应于某种特定的先验分布，该先验倾向于低频的位置变化，与自然语言中位置依赖的统计特性相符。这种先验防止模型学习过于高频的位置变化模式，起到正则化的作用。

位置编码需要为每个位置生成唯一的表示。从频率域的角度，编码的唯一性由各频率成分的线性无关性保证。每个位置$i$对应唯一的相位向量$(\theta_{i,0}, \theta_{i,1}, \ldots, \theta_{i,d_{\text{model}}/2-1})$。由于各频率$f_m$互不相同，相位向量的映射是一一对应的。这个结论的严格证明需要用到多重频率系统的唯一性定理，该定理表明对于互不谐波的多个频率，位置到相位向量的映射是单射。

从傅里叶分析的角度，位置编码可以视为在频率空间中"预定义"了频率成分。与通过DFT从数据中学习频率不同，正弦余弦编码直接指定了频率分布。这种设计基于一个重要的先验假设：位置信息可以用不同频率的正弦波有效表示。这个假设在实践中被证明是有效的，原因在于正弦波是描述周期性和位置变化的最基本函数，它们能够以最小的参数编码最多的位置信息。

### 6.1.5 本节小结

本节从数学角度系统分析了正弦余弦位置编码的理论基础。我们首先给出了位置编码的统一数学表达式，从原始的分量形式推导出复数形式的紧凑表达，展示了正弦和余弦如何统一为复指数运算。然后我们从频率空间的角度分析了位置编码的数学结构，揭示了编码向量如何被视为不同频率正弦波的叠加，以及指数分布的频率如何提供多尺度的位置分辨率。

我们深入探讨了相位偏移的几何意义，展示了位置编码如何对应于复平面上不同频率成分的独立旋转，相对位置如何对应于相对旋转角度，以及位置变换算子如何在对角化的频率空间中作用。最后，我们分析了固定基函数的数学本质，证明了基函数集合的线性无关性和正交性，解释了为什么这组固定基函数能够唯一表示任意位置，同时具有良好的长度外推能力和泛化特性。通过本节的学习，读者应该建立起对正弦余弦位置编码数学本质的深入理解，为后续学习更复杂的位置编码方案奠定坚实的理论基础。