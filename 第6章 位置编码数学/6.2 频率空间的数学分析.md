正弦余弦位置编码的精妙之处在于其背后的频率空间（Frequency Space）数学结构。编码公式中的正弦和余弦函数不是随意选择的，而是经过精心设计的频率成分，它们的组合形成了一个能够唯一表示序列位置的编码系统。从傅里叶分析的角度来看，正弦余弦位置编码实际上是在频率空间中构造位置信息的表示，这种构造方式具有深刻的数学理论基础和优雅的性质。

频率空间分析为我们理解位置编码提供了全新的视角。在频率空间中，位置编码不再是孤立的数值向量，而是不同频率正弦波的叠加。低频成分捕获位置的整体结构和长距离关系，高频成分捕获位置的精细变化和短距离差异。这种多尺度的频率表示与人类感知和处理信息的方式有着有趣的相似性，也为分析位置编码的性质（如相对位置表达能力、外推能力等）提供了有力的数学工具。

本节将从傅里叶分析的基本原理出发，系统地分析正弦余弦位置编码的频谱结构、频率选择与编码分辨率的关系、相对位置的频率表示，以及复数形式的统一分析。通过本节的学习，读者将建立起对位置编码频率空间本质的深入理解，为后续学习更复杂的位置编码方案（如旋转位置编码）奠定坚实的理论基础。

## 6.2.1傅里叶分析基础


傅里叶级数是分析周期函数的经典工具，它将任意周期函数表示为不同频率正弦和余弦函数的叠加。设$f(t)$是周期为$T$的周期函数，即$f(t + T) = f(t)$对于所有$t$成立。傅里叶级数展开定义为：
$$
f(t) = \frac{a_0}{2} + \sum_{n=1}^{\infty} \left[ a_n \cos\left(\frac{2\pi n t}{T}\right) + b_n \sin\left(\frac{2\pi n t}{T}\right) \right] \tag{6.2.1}
$$
其中，傅里叶系数$a_n$和$b_n$​通过以下积分计算：
$$
a_n = \frac{2}{T} \int_{0}^{T} f(t) \cos\left(\frac{2\pi n t}{T}\right) dt, \quad b_n = \frac{2}{T} \int_{0}^{T} f(t) \sin\left(\frac{2\pi n t}{T}\right) dt \tag{6.2.2}
$$
傅里叶级数的深刻意义在于：它证明了任意周期函数都可以分解为不同频率正弦和余弦函数的线性组合。频率$n$称为第$n$次谐波，基频为$\omega_0 = 2\pi/T$，第$n$次谐波的角频率为$\omega_0$​。不同的频率成分携带函数的不同"信息"：低频成分描述函数的整体趋势，高频成分描述函数的细节变化。

在复数形式下，傅里叶级数可以更加简洁地表示。引入复指数函数$e^{i\omega t} = \cos(\omega t) + i\sin(\omega t)$，周期函数可以展开为：
$$
f(t) = \sum_{n=-\infty}^{\infty} c_n e^{i \frac{2\pi n t}{T}} \tag{6.2.3}
$$
其中，复数系数$c_n = \frac{1}{T} \int_{0}^{T} f(t) e^{-i \frac{2\pi n t}{T}} dt$。复数形式的优点在于：它统一处理正弦和余弦分量，数学表达式更加紧凑，且便于进行复变函数分析。


当处理离散序列（如位置编码）时，需要使用离散傅里叶变换（Discrete Fourier Transform，DFT）。设离散序列$x[n] = x_0, x_1, \ldots, x_{N-1}$，其DFT定义为：
$$
X[k] = \sum_{n=0}^{N-1} x[n] e^{-i \frac{2\pi k n}{N}}, \quad k = 0, 1, \ldots, N-1 \tag{6.2.4}
$$
逆变换为：
$$
x[n] = \frac{1}{N} \sum_{k=0}^{N-1} X[k] e^{i \frac{2\pi k n}{N}} \tag{6.2.5}
$$
DFT将离散序列从时域（这里对应位置域）变换到频域，输出$X[k]$表示第$k$个频率成分的复振幅。频率$k$对应的角频率为$\omega_k = 2\pi k/N$，周期为$T_k = N/k$（当$k \neq 0$时）。

对于位置编码的分析，我们可以将位置$i$的编码向量视为一个离散序列，维度$m$对应不同的频率成分。正弦余弦位置编码可以视为在频域中"预定义"了频率成分——我们不是通过DFT从数据中学习频率，而是直接指定了频率分布。

快速傅里叶变换（Fast Fourier Transform，FFT）是计算DFT的高效算法，将复杂度从$O(N^2)$降低到$O(N \log N)$。虽然位置编码不需要实际计算FFT，但FFT的数学框架为理解位置编码的频谱性质提供了重要的理论基础。
傅里叶分析揭示了时间域（位置域）与频率域之间的深刻对偶关系。这种对偶性体现在多个方面。首先是周期性对偶。位置域中的平移对应于频率域中的相位偏移。设序列$x[n]$的DFT为$X[k]$，则平移序列$x[n−m]$的DFT为$e^{-i \frac{2\pi k m}{N}} X[k]$，频率成分不变，但每个频率成分乘以一个相位因子。这个性质与位置编码中的相对位置表示密切相关。
其次是卷积对偶。位置域中的卷积对应于频率域中的乘积。设$y[n] = (x * h)[n] = \sum_{m} x[m] h[n - m]$，则$Y[k] = X[k] \cdot H[k]$。这个性质在分析注意力机制的频率特性时很有用。
第三是分辨率对偶。位置域中时间分辨率（位置区分精度）与频率域中频率分辨率（区分相近频率的能力）存在权衡关系。给定的序列长度$N$限制了可分析的频率范围和频率分辨率，低频端可分辨的最小频率间隔为$2\pi/N$，高频端可表示的最高频率受奈奎斯特采样定理限制。

在位置编码的语境下，序列长度$n$和嵌入维度$d_{\text{model}}$​共同决定了可用的频率范围。低维度（低频成分）使用较低的频率，能够覆盖较长的位置范围；高维度（高频成分）使用较高的频率，能够精细区分相近的位置。这种设计与频率域和位置域的对偶性完全一致。

## 6.2.2 正弦余弦编码的频谱结构

正弦余弦位置编码可以自然地视为不同频率正弦波的叠加。考虑位置$i$的编码向量$p_i$​，将其按维度配对$(p_{i,2m}, p_{i,2m+1})$组织，每个配对对应一个特定的频率成分。

对于维度配对$m$，定义复数形式的编码分量：
$$
c_{i,m} = p_{i,2m} + i \cdot p_{i,2m+1} = \sin\left(\frac{i}{\omega_m}\right) + i \cos\left(\frac{i}{\omega_m}\right) = e^{i \frac{i}{\omega_m}} \tag{6.2.6}
$$
其中，$\omega_m = 10000^{2m/d_{\text{model}}}$​是第$m$个频率的周期参数。使用欧拉公式$e^{i\theta} = \cos\theta + i\sin\theta$，可以验证：
$$
e^{i \frac{i}{\omega_m}} = \cos\left(\frac{i}{\omega_m}\right) + i \sin\left(\frac{i}{\omega_m}\right) \tag{6.2.7}
$$
这与编码向量($p_{i,2m}, p_{i,2m+1}) = (\sin(i/\omega_m), \cos(i/\omega_m))$)相比，符号有所不同。通过调整相位，可以统一表示。设编码向量为：
$$
c_{i,m} = \cos\left(\frac{i}{\omega_m}\right) - i \sin\left(\frac{i}{\omega_m}\right) = e^{-i \frac{i}{\omega_m}} \tag{6.2.8}
$$
则实部和虚部正好对应编码的奇数维度和偶数维度。

从频谱的角度，每个$c_{i,m}$是一个复指数序列，其频率为$\omega_m^{-1}$​。整个编码向量是不同频率复指数序列的实部和虚部的组合，即：
$$
p_i = \begin{bmatrix} \text{Re}(c_{i,0}) & \text{Im}(c_{i,0}) & \text{Re}(c_{i,1}) & \text{Im}(c_{i,1}) & \cdots & \text{Re}(c_{i,d_{\text{model}}/2-1}) & \text{Im}(c_{i,d_{\text{model}}/2-1}) \end{bmatrix}^T \tag{6.2.9}
$$

位置编码的各频率成分具有不同的"能量"——可以用振幅或方差来度量。考虑第$m$个频率成分的复指数序列$c_{i,m} = e^{-i/\omega_m}$。由于这是一个单位复指数，其模为1，能量集中。

实部序列$\text{Re}(c_{i,m}) = \cos(i/\omega_m)$和虚部序列$\text{Im}(c_{i,m}) = -\sin(i/\omega_m)$都是振幅为1的正弦波。在长度为$n$的序列上，这些序列的平均功率为：
$$
\frac{1}{n} \sum_{i=0}^{n-1} \cos^2\left(\frac{i}{\omega_m}\right) = \frac{1}{n} \sum_{i=0}^{n-1} \sin^2\left(\frac{i}{\omega_m}\right) = \frac{1}{2} \tag{6.2.10}
$$
这表明每个频率成分具有相同的能量，振幅为1，相位均匀分布。

在傅里叶分析的语境下，位置编码的频谱可以表示为冲激函数的叠加：
$$
X[k] = \sum_{m=0}^{d_{\text{model}}/2-1} \delta(k - k_m) \tag{6.2.11}
$$
其中，$k_m$​是与频率$\omega_m^{-1}$​对应的频率索引，$\delta(\cdot)$是克罗内克$\delta$函数（离散情况）或狄拉克$\delta$函数（连续情况）。这个频谱表示表明：位置编码的能量完全集中在有限的几个离散频率上，没有连续的分量。


正弦余弦位置编码采用指数分布的频率：$\omega_m = 10000^{2m/d_{\text{model}}}$。这种多尺度的频率结构具有深刻的数学意义。

从对数频率的角度来看，各频率成分在对数尺度上是均匀分布的。考虑频率$f_m = 1/\omega_m = 10000^{-2m/d_{\text{model}}}$，则：
$$
\log_{10000}(f_m) = -\frac{2m}{d_{\text{model}}} \tag{6.2.12}
$$
这意味着频率在对数域上是等间隔分布的。这种设计使得编码能够在多个数量级上同时捕获位置信息：低频成分覆盖长距离的位置关系，高频成分覆盖短距离的位置关系。

从分辨率的角度，不同频率成分提供不同精度的位置表示。低频成分（如$f_0 = 1$）的周期为1，能够区分非常接近的位置；高频成分（如$f_{d_{\text{model}}/2-1} = 10000^{-1}$）的周期为10000，能够覆盖整个长序列。这种多分辨率分析与小波变换（Wavelet Transform）的思想一致，使用不同尺度的基函数同时捕获全局和局部特征。

从信息论的角度，位置编码需要为$n$个位置编码约$\log_2 n$比特的信息。多尺度频率结构可以看作是一种高效的编码方案：它不是为每个位置独立编码，而是使用不同频率的正弦波叠加来表示位置。这种编码方式在数学上具有完备性——给定足够多的频率成分，可以唯一确定任意位置。

## 6.2.3 频率选择与编码分辨率
位置编码中频率参数$\omega_m = 10000^{2m/d_{\text{model}}}$的几何直觉可以通过圆周运动来理解。每个频率成分对应一个在单位圆上匀速运动的点，其角速度为$\theta_m(i) = i / \omega_m$​。当$i$增加1时，该点在圆周上旋转的角度为$1/\omega_m$。

对于低维度（小的$m$），$\omega_m$​较小，旋转角度较大，点迅速遍历整个圆周。这意味着相邻位置在编码中会有显著差异，能够精细区分相近的位置。对于高维度（大的$m$），$\omega_m$​较大，旋转角度较小，点运动缓慢，需要很多步才能遍历整个圆周。这意味着相邻位置在编码中差异较小，适合捕获整体位置信息。

考虑两个位置$i$和$i+1$的编码向量$p_i$​和$p_{i+1}$​。它们的差向量为：
$$
p_{i+1} - p_i = \begin{bmatrix} \sin\left(\frac{i+1}{\omega_m}\right) - \sin\left(\frac{i}{\omega_m}\right) \\ \cos\left(\frac{i+1}{\omega_m}\right) - \cos\left(\frac{i}{\omega_m}\right) \end{bmatrix} \approx \begin{bmatrix} \frac{1}{\omega_m} \cos\left(\frac{i}{\omega_m}\right) \\ -\frac{1}{\omega_m} \sin\left(\frac{i}{\omega_m}\right) \end{bmatrix} \tag{6.2.13}
$$
对于小的旋转角度（$\Delta\theta = 1/\omega_m \ll 1$），差向量的模约为$\Delta\theta = 1/\omega_m$。因此，高频成分（大的$\omega_m$）的相邻位置差较小，低频成分（小的$\omega_m$）的相邻位置差较大。

位置编码的分辨率，即区分两个相近位置的能力取决于频率成分的选择。考虑位置$i$和$i + \delta$（$\delta$是小的距离差），它们的编码向量分别为$p_i$​和$p_{i+\delta}$​。

使用三角恒等式，编码差可以表示为：
$$
p_{i+\delta} - p_i = \begin{bmatrix} \sin\left(\frac{i+\delta}{\omega_m}\right) - \sin\left(\frac{i}{\omega_m}\right) \\ \cos\left(\frac{i+\delta}{\omega_m}\right) - \cos\left(\frac{i}{\omega_m}\right) \end{bmatrix} = \begin{bmatrix} 2 \cos\left(\frac{2i+\delta}{2\omega_m}\right) \sin\left(\frac{\delta}{2\omega_m}\right) \\ -2 \sin\left(\frac{2i+\delta}{2\omega_m}\right) \sin\left(\frac{\delta}{2\omega_m}\right) \end{bmatrix} \tag{6.2.14}
$$
差向量的模为：
$$
\|p_{i+\delta} - p_i\| = 2 \left| \sin\left(\frac{\delta}{2\omega_m}\right) \right| \approx \left| \frac{\delta}{\omega_m} \right| \quad \text{当 } \delta \ll \omega_m \text{ 时} \tag{6.2.15}
$$
这个结果清楚地表明：位置差$\delta$的编码分辨率与频率$\omega_m$成反比。对于高频成分（大的$\omega_m$​），相同的位置差产生的编码差异较小；对于低频成分（小的$\omega_m$​），相同的位置差产生的编码差异较大。

在实际编码中，不同维度使用不同的频率，使得编码向量能够同时表达多个尺度的位置信息。低维度对位置变化敏感，适合区分很近的位置；高维度对位置变化不敏感，适合区分较远的位置。这种多尺度设计使得位置编码能够适应不同粒度的位置相关建模需求。
位置编码能够有效表示的序列长度范围与频率参数的配置密切相关。考虑能够唯一表示长度$n$序列所需的最低频率。对于最高频率成分$f_{\max} = 1/\omega_0 = 1$，周期为1，这意味着编码可以区分相邻位置。对于最低频率成分$f_{\min} = 1/\omega_{d_{\text{model}}/2-1} = 10000^{-1}$，周期为10000。

理论上，只要序列长度$n$不超过最低频率成分的周期，编码就能够为每个位置生成唯一的表示。当$n>10000$时，最低频率成分的周期小于序列长度，可能出现"折叠"现象，不同位置的编码趋于相似。然而，由于编码包含多个频率成分，即使最低频率成分出现折叠，其他高频成分仍然能够区分不同位置。

从频率分析的角度，能够唯一表示$n$个位置的最小频率间隔（频率分辨率）为$\Delta f = 1/n$。位置编码的频率成分间隔为：
$$
\begin{align}
\Delta f_m = f_m - f_{m-1} & = 10000^{-2(m-1)/d_{\text{model}}} - 10000^{-2m/d_{\text{model}}} \\&= 10000^{-2(m-1)/d_{\text{model}}} \left(1 - 10000^{-2/d_{\text{model}}}\right) \tag{6.2.16}
\end{align}
$$
当$d_{\text{model}}$较大时，$10000^{-2/d_{\text{model}}} \approx 1 - \frac{2 \ln 10000}{d_{\text{model}}}$​，频率间隔近似为：
$$
\Delta f_m \approx \frac{2 \ln 10000}{d_{\text{model}}} \cdot 10000^{-2(m-1)/d_{\text{model}}} \tag{6.2.17}
$$
这个间隔随$m$增大而减小，低频成分的间隔较大，高频成分的间隔较小。这种设计确保了频率分辨率与位置分辨率的匹配。

## 6.2.4 相对位置的频率表示
位置编码的核心要求之一是能够表示相对位置。位置编码的点积$p_i \cdot p_j$只依赖于相对位置$\Delta = i - j$，与绝对位置$i$和$j$无关。从频率域的角度，我们可以更深入地理解这一性质的来源。

将点积公式重写为：
$$
p_i \cdot p_j = \sum_{m=0}^{d_{\text{model}}/2-1} \cos\left(\frac{\Delta}{\omega_m}\right) = \sum_{m=0}^{d_{\text{model}}/2-1} \cos\left(\Delta \cdot f_m\right) \tag{6.2.18}
$$
其中，$f_m = 1/\omega_m = 10000^{-2m/d_{\text{model}}}$​是第$m$个频率成分的频率。这个表达式清楚地表明：点积是相对位置$\Delta$的函数，而非绝对位置的函数。

从傅里叶分析的角度，位置编码点积作为相对位置$\Delta$的函数，可以视为一个傅里叶级数展开。各项$\cos(\Delta \cdot f_m)$正是这个函数的傅里叶基函数。因此，相对位置信息被"编码"在频率域中，不同的频率成分贡献不同的相对位置表示。

相对位置的频率表示具有以下特点：第一，平移不变性，点积不依赖于绝对位置，只依赖于相对位置，这使得模型能够学习与位置无关的相对依赖模式。第二，对称性，$p_i \cdot p_j = p_j \cdot p_i$​，因为$\cos(-\Delta) = \cos(\Delta)$，这反映了相对位置的对称性。第三，周期性，由于余弦函数的周期性，点积随$\Delta$呈周期性变化，但周期非常大（受最低频率限制）。
从相位角度理解位置编码，可以获得更深刻的洞察。考虑编码向量$p_i$​的每个维度配对$(p_{i,2m}, p_{i,2m+1}) = (\sin(\theta_{i,m}), \cos(\theta_{i,m}))$，其中$\theta_{i,m} = i / \omega_m = i \cdot f_m$​是第$m$个频率成分在位置$i$处的相位。

相位$\theta_{i,m} = i \cdot f_m$​随位置$i$线性增加，增长率为频率$f_m$​。因此，位置编码可以理解为：在每个频率维度上，相位随位置均匀进动，就像一个旋转的指针，转速由频率决定。

两个位置的相位差为$\Delta\theta_m = \theta_{j,m} - \theta_{i,m} = (j - i) \cdot f_m = \Delta \cdot f_m$​。这个相位差正好对应点积公式中的$\cos(\Delta \cdot f_m)$项。点积可以解释为各频率成分相位差余弦的叠加。

从群论的角度，相位编码对应于圆群（Circle Group）上的平移操作。每个频率成分定义了一个独立的圆群，位置$i$对应圆群上的点$e^{i\theta_{i,m}}$。相对位置对应于圆群上的平移，其效果是两个点的"距离"（由点积给出）与绝对位置无关。

位置编码需要为每个位置生成唯一的表示。从频率域的角度，编码的唯一性由各频率成分的线性无关性保证。
考虑编码向量序列$\{p_0, p_1, \ldots, p_{n-1}\}$。假设存在非零系数$\alpha_i$​使得：
$$
\sum_{i=0}^{n-1} \alpha_i p_i = 0 \tag{6.2.19}
$$
将$p_i$​按频率成分展开：
$$
\sum_{i=0}^{n-1} \alpha_i \begin{bmatrix} \sin(i f_0) \\ \cos(i f_0) \\ \sin(i f_1) \\ \cos(i f_1) \\ \vdots \end{bmatrix} = 0 \tag{6.2.20}
$$
对于每个频率$f_m$​，有：
$$
\sum_{i=0}^{n-1} \alpha_i \sin(i f_m) = 0, \quad \sum_{i=0}^{n-1} \alpha_i \cos(i f_m) = 0 \tag{6.2.21}
$$
这些方程表明：权重序列$\alpha_i$​与正弦序列$\{\sin(i f_m)\}$和余弦序列$\{\cos(i f_m)\}$正交。由于频率$f_m$​是互不相同的无理数倍数（当$d_{\text{model}}$足够大时），所有这些正交条件意味着$\alpha_i = 0$对于所有$i$成立。因此，编码向量序列是线性无关的，不同位置具有不同的编码。

唯一性的另一个角度是相位唯一性。每个位置$i$对应唯一的相位向量$(\theta_{i,0}, \theta_{i,1}, \ldots, \theta_{i,d_{\text{model}}/2-1})$。由于各频率$f_m$互不相同（无理数比率），相位向量的映射是一一对应的。这个结论的严格证明需要用到多重频率系统的唯一性定理，该定理表明：对于互不谐波的多个频率，位置到相位向量的映射是单射。

## 6.2.5 复数形式的统一分析

使用复数形式可以更优雅地表示正弦余弦位置编码。定义位置$i$的复数编码向量$c_i \in \mathbb{C}^{d_{\text{model}}/2}$为：
$$
c_i[m] = e^{-i \frac{i}{\omega_m}} = \exp\left(-i \cdot i \cdot 10000^{-2m/d_{\text{model}}}\right), \quad m = 0, 1, \ldots, d_{\text{model}}/2 - 1 \tag{6.2.22}
$$
其中，$i = \sqrt{-1}$是虚数单位。这个复数编码与实数编码的关系为：
$$
c_i[m] = \cos\left(\frac{i}{\omega_m}\right) - i \sin\left(\frac{i}{\omega_m}\right) \tag{6.2.23}
$$
实数编码向量可以通过取复数编码的实部和虚部得到：
$$
\begin{equation}
p_i =
\begin{aligned}[t]
\begin{bmatrix}
\text{Re}(c_i[0]) & \text{Im}(c_i[0]) & \text{Re}(c_i[1]) & \text{Im}(c_i[1]) \\
\cdots & \text{Re}(c_i[d_{\text{model}}/2-1]) & \text{Im}(c_i[d_{\text{model}}/2-1])
\end{bmatrix}^{\!T}
\end{aligned}
\tag{6.2.24}
\end{equation}

$$
复数形式的优雅之处在于：它将正弦和余弦统一为一个复指数运算，消除了分别处理正弦和余弦的复杂性。

复数编码的内积具有简洁的形式。考虑两个复数编码向量$c_i$​和$c_j$​，它们的内积（复内积，第二个向量取共轭）为：
$$
\langle c_i, c_j \rangle = \sum_{m=0}^{d_{\text{model}}/2-1} c_i[m] \cdot \overline{c_j[m]} = \sum_{m=0}^{d_{\text{model}}/2-1} e^{-i \frac{i}{\omega_m}} \cdot e^{i \frac{j}{\omega_m}} = \sum_{m=0}^{d_{\text{model}}/2-1} e^{-i \frac{i-j}{\omega_m}} \tag{6.2.25}
$$
实数编码的点积与复数编码的内积直接相关：
$$
p_i \cdot p_j = \text{Re}\left( \sum_{m=0}^{d_{\text{model}}/2-1} c_i[m] \cdot \overline{c_j[m]} \right) = \sum_{m=0}^{d_{\text{model}}/2-1} \cos\left(\frac{i-j}{\omega_m}\right) \tag{6.2.26}
$$
内积的虚部为：
$$
\text{Im}\left( \sum_{m=0}^{d_{\text{model}}/2-1} e^{-i \frac{i-j}{\omega_m}} \right) = -\sum_{m=0}^{d_{\text{model}}/2-1} \sin\left(\frac{i-j}{\omega_m}\right) \tag{6.2.27}
$$
虚部包含正弦项，但通常不用于位置编码的分析。

复数编码提供了理解位置变换的另一个视角。考虑位置$i$的复数编码$c_i$​，它可以视为复平面上单位圆上的一个点，其辐角为$\theta_{i,m} = -i / \omega_m$。当位置从$i$变为$i+1$时，辐角增加$\Delta\theta_m = -1/\omega_m$​，即点沿圆周旋转角度$-1/\omega_m$。

两个位置的编码之间的关系可以通过相对旋转来描述。设$c_i$​和$c_j$​是位置$i$和$j$的编码，则：
$$
c_j = c_i \cdot e^{-i \frac{j-i}{\omega_m}} = c_i \cdot \exp\left(-i \cdot \Delta \cdot f_m\right) \tag{6.2.28}
$$
这意味着$c_j$​可以通过将$c_i$​在复平面上旋转角度$\Delta \cdot f_m$得到。因此，相对位置对应于复平面上的相对旋转，旋转角度由相对位置和频率共同决定。

从几何角度，每个频率成分定义了一个独立的复平面，位置编码是这些平面上点的集合。相对位置编码问题转化为：给定两个点在各自平面上的位置，计算它们之间的相对旋转角度。这种几何解释与旋转位置编码（RoPE）有深刻的联系，RoPE正是将这种几何直觉推广到高维向量空间。

从线性代数的角度，位置编码可以视为定义在频率空间上的一组线性算子。考虑位置变换算子$T$，它将位置$i$的编码映射到位置$i+1$的编码：
$$
T(c_i) = c_{i+1} \tag{6.2.29}
$$
使用复数编码，这个算子可以表示为：
$$
T(c_i)[m] = c_{i+1}[m] = e^{-i \frac{i+1}{\omega_m}} = e^{-i \frac{i}{\omega_m}} \cdot e^{-i \frac{1}{\omega_m}} = c_i[m] \cdot r_m \tag{6.2.30}
$$
其中，$r_m = e^{-i / \omega_m}$是第$m$个频率成分对应的旋转因子。因此，位置变换算子$T$在频率空间中是一个对角矩阵，对角元素为各频率成分的旋转因子$r_m$​。

位置$i$的编码可以表示为初始编码$c_0$​经过$T^i$次变换的结果：
$$
c_i = T^i(c_0) = \text{diag}(r_0^i, r_1^i, \ldots, r_{d_{\text{model}}/2-1}^i) c_0 \tag{6.2.31}
$$
其中，$r_m^i = e^{-i / \omega_m}$​。这个表达式清楚地揭示了位置编码的生成机制：位置$i$的编码是初始编码经过各频率成分独立旋转$i$次后的结果。

## 6.2.6 频率空间与位置空间的对偶性

傅里叶变换的核心是对偶性，时域和频域之间的对偶关系。这种对偶性在位置编码中有深刻的体现。

设$x[i]$是一个离散序列，其傅里叶变换为$X[k]$。对偶性意味着：如果对$x[i]$进行平移$x[i + m]$，则傅里叶变换变为$X[k] e^{i \frac{2\pi k m}{N}}$，频率不变，但每个频率成分乘以一个相位因子。反之，如果对$X[k]$进行某种操作，对应的时域序列会受到影响。

在位置编码的语境下，位置$i$的编码$p_i$​可以视为频率域中的"冲激"序列。从频率域看，位置编码的能量集中在离散的频率点上；从位置域看，每个位置是一个独特的编码向量。这种对偶性使得位置编码能够同时在两个域中表示信息。

正弦余弦位置编码的频率选择（指数分布）是否是最优的？这是一个值得深入分析的问题。

从覆盖范围的角度，指数分布的频率确保了从低频到高频的广泛覆盖。最低频率$f_{\min} = 10000^{-1}$对应周期10000，最高频率$f_{\max} = 1$对应周期1。这种覆盖范围对于常见的序列长度（如几百到几千）是足够的。

从分辨率的角度，指数分布提供了对数尺度的均匀分辨率。对数频率轴上的等间隔对应于几何级数的频率间隔，这种分布在多个数量级上提供了一致的分辨率。

从参数效率的角度，$d_{\text{model}}/2$个频率成分能够编码约$\log_2(10000) \times d_{\text{model}}/2 \approx 6.6 \times d_{\text{model}}$​比特的信息（假设每个频率成分独立）。对于$d_{\text{model}} = 512$，这约能编码3400比特的信息，足以唯一标识远超过任何实际序列长度的位置。

然而，指数分布是否是绝对最优的？答案取决于具体任务和评估标准。某些任务可能需要更精细的低频分辨率（更低的最低频率），某些任务可能需要更精细的高频分辨率（更多的频率成分）。实践中，正弦余弦编码的参数选择是通过实验调优确定的，在各种任务上表现良好。

位置编码的频率结构对模型的正则化和泛化能力有重要影响。从频率域的角度，我们可以理解为什么位置编码能够帮助模型更好地泛化。

首先，位置编码的频率结构引入了一种隐式的先验，位置信息可以用低频到中频的成分表示，高频成分不携带信息（因为编码不使用极高频率）。这种先验防止模型学习过于高频的位置变化模式，起到正则化的作用。

其次，频率域的稀疏性（能量集中在有限的频率点）意味着位置编码的参数是高度结构化的，而非完全自由的。这种结构化参数具有更好的泛化能力，模型学习到的是位置的"规律性"模式，而非训练位置的"记忆"。

第三，位置编码的平滑性（相邻位置的编码变化平滑）使得模型难以对位置进行过拟合。模型必须学习平滑的位置表示，而非对特定位置的精确记忆。这种平滑性是泛化的重要保障。

从贝叶斯推断的角度，位置编码可以视为对位置先验的一种建模。指数频率分布对应于某种特定的先验分布，该先验倾向于低频的位置变化，与自然语言中位置依赖的统计特性相符。

## 6.2.7 本节小结

本节从频率空间的角度系统分析了正弦余弦位置编码的数学原理。我们首先回顾了傅里叶分析的基础知识，包括周期函数的傅里叶级数展开、离散序列的傅里叶变换，以及时域与频域之间的对偶性。这些数学工具为深入理解位置编码奠定了基础。

我们详细分析了位置编码的频谱结构，揭示了编码向量可以视为不同频率正弦波的叠加，每个频率成分具有相同的能量，但提供不同尺度的位置分辨率。低频成分捕获长距离的位置关系，高频成分捕获短距离的位置变化。

我们深入探讨了频率选择与编码分辨率的关系。通过数学推导，我们证明了位置差$\delta$的编码分辨率与频率$\omega_m$​成反比，解释了为什么低维度使用低频、高维度使用高频的设计能够提供多尺度的位置表示。

我们从频率域的角度重新分析了相对位置的编码，揭示了点积$p_i \cdot p_j$​作为相对位置$\Delta = i - j$的函数，本质上是各频率成分相位差余弦的叠加。这种表示具有平移不变性和对称性，是位置编码能够有效支持位置相关建模的关键。

我们还介绍了复数形式的统一分析，展示了如何使用复指数函数简洁地表示位置编码，以及如何从复数旋转的角度理解位置变换。最后，我们讨论了频率域与位置域的对偶性，以及频率选择的最优性和正则化效应。

通过本节的学习，读者应该建立起对位置编码频率空间本质的深入理解。频率空间的视角不仅帮助我们理解正弦余弦编码的数学原理，也为下一节学习可学习位置编码的矩阵性质、以及后续学习旋转位置编码（RoPE）奠定了坚实的理论基础。